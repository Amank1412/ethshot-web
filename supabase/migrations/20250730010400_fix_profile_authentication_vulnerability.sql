-- Migration: Fix Critical Profile Authentication Vulnerability
-- Created: 2025-07-30 01:04:00 UTC
-- Description: Replace upsert_user_profile_secure with a truly secure version that
--              gets wallet address from JWT context instead of trusting client input

-- Drop the vulnerable function that accepts wallet_address as parameter
DROP FUNCTION IF EXISTS upsert_user_profile_secure(text, text, text, text, text, text, text, boolean, boolean);

-- Create a new secure function that gets wallet address from JWT authentication context
-- This function does NOT accept wallet_address as a parameter - it gets it from auth.jwt()
CREATE OR REPLACE FUNCTION upsert_user_profile_secure(
  p_nickname text DEFAULT NULL,
  p_bio text DEFAULT NULL,
  p_avatar_url text DEFAULT NULL,
  p_twitter_handle text DEFAULT NULL,
  p_discord_handle text DEFAULT NULL,
  p_website_url text DEFAULT NULL,
  p_notifications_enabled boolean DEFAULT NULL,
  p_debug_mode boolean DEFAULT NULL
)
RETURNS json
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_wallet_address text;
  v_user_id uuid;
  v_result json;
  v_jwt_claims json;
BEGIN
  -- Get the JWT claims from the current session
  v_jwt_claims := auth.jwt();
  
  -- Ensure user is authenticated
  IF v_jwt_claims IS NULL THEN
    RAISE EXCEPTION 'Authentication required: No JWT token found';
  END IF;
  
  -- Extract wallet address from JWT claims
  -- Try multiple possible claim locations for compatibility
  v_wallet_address := COALESCE(
    v_jwt_claims->>'walletAddress',
    v_jwt_claims->>'wallet_address', 
    v_jwt_claims->>'sub'
  );
  
  -- Validate that we have a wallet address
  IF v_wallet_address IS NULL OR LENGTH(v_wallet_address) < 10 THEN
    RAISE EXCEPTION 'Invalid authentication: No wallet address found in JWT token';
  END IF;
  
  -- Normalize wallet address to lowercase
  v_wallet_address := LOWER(v_wallet_address);
  
  -- Log the authenticated wallet address for debugging
  RAISE NOTICE 'Authenticated wallet address: %', v_wallet_address;

  -- Get existing user ID or create new user
  SELECT id INTO v_user_id
  FROM user_profiles
  WHERE wallet_address = v_wallet_address;

  IF v_user_id IS NULL THEN
    -- Create new user profile
    INSERT INTO user_profiles (
      wallet_address,
      nickname,
      bio,
      avatar_url,
      twitter_handle,
      discord_handle,
      website_url,
      notifications_enabled,
      debug_mode
    ) VALUES (
      v_wallet_address,
      p_nickname,
      p_bio,
      p_avatar_url,
      p_twitter_handle,
      p_discord_handle,
      p_website_url,
      COALESCE(p_notifications_enabled, TRUE),
      COALESCE(p_debug_mode, FALSE)
    ) RETURNING id INTO v_user_id;
  ELSE
    -- Update existing user profile (only update non-null values)
    UPDATE user_profiles
    SET
      nickname = COALESCE(p_nickname, nickname),
      bio = COALESCE(p_bio, bio),
      avatar_url = COALESCE(p_avatar_url, avatar_url),
      twitter_handle = COALESCE(p_twitter_handle, twitter_handle),
      discord_handle = COALESCE(p_discord_handle, discord_handle),
      website_url = COALESCE(p_website_url, website_url),
      notifications_enabled = COALESCE(p_notifications_enabled, notifications_enabled),
      debug_mode = COALESCE(p_debug_mode, debug_mode),
      updated_at = NOW()
    WHERE id = v_user_id;
  END IF;

  -- Return the updated/created user profile
  SELECT json_build_object(
    'id', id,
    'wallet_address', wallet_address,
    'nickname', nickname,
    'bio', bio,
    'avatar_url', avatar_url,
    'twitter_handle', twitter_handle,
    'discord_handle', discord_handle,
    'website_url', website_url,
    'notifications_enabled', notifications_enabled,
    'debug_mode', debug_mode,
    'is_admin', is_admin,
    'created_at', created_at,
    'updated_at', updated_at
  ) INTO v_result
  FROM user_profiles
  WHERE id = v_user_id;

  RETURN v_result;
END;
$$;

-- Grant execute permission to authenticated users only
GRANT EXECUTE ON FUNCTION upsert_user_profile_secure(
  text, -- p_nickname
  text, -- p_bio
  text, -- p_avatar_url
  text, -- p_twitter_handle
  text, -- p_discord_handle
  text, -- p_website_url
  boolean, -- p_notifications_enabled
  boolean -- p_debug_mode
) TO authenticated;

-- Revoke access from anonymous users (extra security)
REVOKE EXECUTE ON FUNCTION upsert_user_profile_secure(
  text, text, text, text, text, text, boolean, boolean
) FROM anon;

-- Add comment explaining the security fix
COMMENT ON FUNCTION upsert_user_profile_secure(
  text, text, text, text, text, text, boolean, boolean
) IS 'SECURE: Profile upsert function that gets wallet address from JWT authentication context instead of trusting client input. Fixes critical authentication bypass vulnerability.';

-- Add Row Level Security (RLS) policies as additional protection
-- Enable RLS on user_profiles table if not already enabled
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Create policy to ensure users can only modify their own profiles
-- This is a backup security measure in case the function is bypassed
CREATE POLICY "Users can only modify their own profiles" ON user_profiles
  FOR ALL USING (
    wallet_address = LOWER(COALESCE(
      auth.jwt()->>'walletAddress',
      auth.jwt()->>'wallet_address',
      auth.jwt()->>'sub'
    ))
  );

-- Create policy for reading profiles (can be public)
CREATE POLICY "Profiles are publicly readable" ON user_profiles
  FOR SELECT USING (true);

-- Log the security fix
COMMENT ON SCHEMA public IS 'Profile authentication vulnerability fixed at 20250730010400 - wallet address now extracted from JWT context instead of client parameter';